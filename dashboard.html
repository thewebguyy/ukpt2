<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Creative Merch UK</title>
  <link rel="stylesheet" href="admin-styles.css">
</head>
<body>
  <!-- Loading Screen -->
  <div id="loadingScreen" class="loading-screen">
    <div class="spinner-large"></div>
    <p>Loading dashboard...</p>
  </div>

  <!-- Main Dashboard -->
  <div id="dashboard" style="display: none;">
    <!-- Header -->
    <header class="dashboard-header">
      <div class="header-content">
        <h1>Creative Merch UK - Admin Dashboard</h1>
        <div class="header-actions">
          <span id="userEmail" class="user-email"></span>
          <button id="logoutBtn" class="btn btn-secondary">Logout</button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="dashboard-main">
      <div class="dashboard-container">
        
        <!-- Add Product Section -->
        <section class="card">
          <h2>Add New Product</h2>
          
          <form id="productForm">
            <div class="form-row">
              <div class="form-group">
                <label for="productName">Product Name *</label>
                <input 
                  type="text" 
                  id="productName" 
                  name="productName" 
                  required 
                  placeholder="e.g., Custom T-Shirt Design"
                  maxlength="200"
                >
              </div>

              <div class="form-group">
                <label for="productPrice">Price (£) *</label>
                <input 
                  type="number" 
                  id="productPrice" 
                  name="productPrice" 
                  required 
                  placeholder="24.99"
                  min="0"
                  step="0.01"
                >
              </div>
            </div>

            <div class="form-group">
              <label for="productDescription">Description *</label>
              <textarea 
                id="productDescription" 
                name="productDescription" 
                required 
                placeholder="Premium quality custom t-shirt made from 100% cotton..."
                rows="4"
                maxlength="2000"
              ></textarea>
              <small class="char-count">0 / 2000 characters</small>
            </div>

            <div class="form-group">
              <label for="productCategory">Category *</label>
              <select id="productCategory" name="productCategory" required>
                <option value="">Select a category</option>
                <option value="apparel">Apparel</option>
                <option value="stickers">Stickers & Labels</option>
                <option value="party-decor">Party Decor</option>
                <option value="accessories">Accessories</option>
              </select>
            </div>

            <div class="form-group">
              <label for="productImage">Product Image *</label>
              <input 
                type="file" 
                id="productImage" 
                name="productImage" 
                accept="image/jpeg,image/png,image/jpg,image/webp" 
                required
              >
              <small>Accepted formats: JPG, PNG, WEBP (Max 5MB)</small>
              
              <!-- Image Preview -->
              <div id="imagePreview" class="image-preview" style="display: none;">
                <img id="previewImg" src="" alt="Preview">
                <button type="button" id="removeImage" class="btn-remove-image">×</button>
              </div>
            </div>

            <button type="submit" class="btn btn-primary" id="submitBtn">
              <span id="submitText">Add Product</span>
              <span id="submitSpinner" class="spinner" style="display: none;"></span>
            </button>

            <div id="uploadProgress" class="upload-progress" style="display: none;">
              <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
              </div>
              <p id="progressText">Uploading...</p>
            </div>
          </form>

          <div id="formMessage" class="form-message" style="display: none;"></div>
        </section>

        <!-- Products List Section -->
        <section class="card">
          <div class="section-header">
            <h2>Uploaded Products</h2>
            <span id="productCount" class="product-count">0 products</span>
          </div>

          <div id="productsContainer" class="products-container">
            <div class="loading-products">
              <div class="spinner"></div>
              <p>Loading products...</p>
            </div>
          </div>
        </section>

      </div>
    </main>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, serverTimestamp, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

    // ========================================
    // FIREBASE CONFIGURATION
    // ========================================
    // TODO: Replace with your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyA6pLJdRb4V5LUUrHdwSKRne-ZgXJoqqY8",
      authDomain: "cmuksite.firebaseapp.com",
      projectId: "cmuksite",
      storageBucket: "cmuksite.firebasestorage.app",
      messagingSenderId: "311601861870",
      appId: "1:311601861870:web:4d3c04c418a789961dcfff"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ========================================
    // DOM ELEMENTS
    // ========================================
    const loadingScreen = document.getElementById('loadingScreen');
    const dashboard = document.getElementById('dashboard');
    const userEmail = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');
    const productForm = document.getElementById('productForm');
    const productNameInput = document.getElementById('productName');
    const productPriceInput = document.getElementById('productPrice');
    const productDescInput = document.getElementById('productDescription');
    const productCategoryInput = document.getElementById('productCategory');
    const productImageInput = document.getElementById('productImage');
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const removeImageBtn = document.getElementById('removeImage');
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const submitSpinner = document.getElementById('submitSpinner');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const formMessage = document.getElementById('formMessage');
    const productsContainer = document.getElementById('productsContainer');
    const productCount = document.getElementById('productCount');
    const charCount = document.querySelector('.char-count');

    let currentUser = null;
    let selectedFile = null;

    // ========================================
    // AUTH STATE OBSERVER
    // ========================================
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        userEmail.textContent = user.email;
        loadingScreen.style.display = 'none';
        dashboard.style.display = 'block';
        
        // Start listening to products
        listenToProducts();
      } else {
        // Not logged in - redirect to login
        window.location.href = 'login.html';
      }
    });

    // ========================================
    // LOGOUT HANDLER
    // ========================================
    logoutBtn.addEventListener('click', async () => {
      if (confirm('Are you sure you want to logout?')) {
        try {
          await signOut(auth);
          window.location.href = 'login.html';
        } catch (error) {
          console.error('Logout error:', error);
          alert('Failed to logout. Please try again.');
        }
      }
    });

    // ========================================
    // IMAGE PREVIEW
    // ========================================
    productImageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      
      if (file) {
        // Validate file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
          showMessage('Image size must be less than 5MB', 'error');
          productImageInput.value = '';
          return;
        }

        // Validate file type
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
        if (!validTypes.includes(file.type)) {
          showMessage('Please select a valid image file (JPG, PNG, or WEBP)', 'error');
          productImageInput.value = '';
          return;
        }

        selectedFile = file;

        // Show preview
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImg.src = e.target.result;
          imagePreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });

    removeImageBtn.addEventListener('click', () => {
      productImageInput.value = '';
      selectedFile = null;
      imagePreview.style.display = 'none';
      previewImg.src = '';
    });

    // ========================================
    // CHARACTER COUNTER
    // ========================================
    productDescInput.addEventListener('input', () => {
      const length = productDescInput.value.length;
      charCount.textContent = `${length} / 2000 characters`;
    });

    // ========================================
    // PRODUCT FORM SUBMISSION
    // ========================================
    productForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!selectedFile) {
        showMessage('Please select a product image', 'error');
        return;
      }

      const name = productNameInput.value.trim();
      const price = parseFloat(productPriceInput.value);
      const description = productDescInput.value.trim();
      const category = productCategoryInput.value;

      // Validation
      if (!name || !price || !description || !category) {
        showMessage('Please fill in all required fields', 'error');
        return;
      }

      if (price <= 0) {
        showMessage('Price must be greater than 0', 'error');
        return;
      }

      // Show loading
      setSubmitLoading(true);
      hideMessage();
      showUploadProgress(0);

      try {
        // 1. Upload image to Firebase Storage
        const timestamp = Date.now();
        const fileName = `${timestamp}_${selectedFile.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
        const storageRef = ref(storage, `products/${fileName}`);
        const uploadTask = uploadBytesResumable(storageRef, selectedFile);

        // Monitor upload progress
        uploadTask.on('state_changed',
          (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            updateUploadProgress(progress);
          },
          (error) => {
            console.error('Upload error:', error);
            throw new Error('Failed to upload image');
          }
        );

        // Wait for upload to complete
        await uploadTask;
        
        // 2. Get download URL
        const imageUrl = await getDownloadURL(storageRef);
        updateUploadProgress(100, 'Saving product data...');

        // 3. Save product to Firestore
        await addDoc(collection(db, 'products'), {
          name: name,
          price: price,
          description: description,
          category: category,
          imageUrl: imageUrl,
          imagePath: `products/${fileName}`, // Store path for deletion
          createdAt: serverTimestamp(),
          createdBy: currentUser.email
        });

        // Success!
        showMessage('Product added successfully!', 'success');
        productForm.reset();
        selectedFile = null;
        imagePreview.style.display = 'none';
        charCount.textContent = '0 / 2000 characters';
        
        // Scroll to products list
        setTimeout(() => {
          productsContainer.scrollIntoView({ behavior: 'smooth' });
        }, 1000);

      } catch (error) {
        console.error('Error adding product:', error);
        showMessage(`Error: ${error.message}`, 'error');
      } finally {
        setSubmitLoading(false);
        hideUploadProgress();
      }
    });

    // ========================================
    // LISTEN TO PRODUCTS (REAL-TIME)
    // ========================================
    function listenToProducts() {
      const q = query(collection(db, 'products'), orderBy('createdAt', 'desc'));
      
      onSnapshot(q, (snapshot) => {
        const products = [];
        
        snapshot.forEach((doc) => {
          products.push({
            id: doc.id,
            ...doc.data()
          });
        });

        displayProducts(products);
      }, (error) => {
        console.error('Error listening to products:', error);
        productsContainer.innerHTML = `
          <div class="error-state">
            <p>Failed to load products. Please refresh the page.</p>
          </div>
        `;
      });
    }

    // ========================================
    // DISPLAY PRODUCTS
    // ========================================
    function displayProducts(products) {
      productCount.textContent = `${products.length} product${products.length !== 1 ? 's' : ''}`;

      if (products.length === 0) {
        productsContainer.innerHTML = `
          <div class="empty-state">
            <p>No products yet. Add your first product above!</p>
          </div>
        `;
        return;
      }

      productsContainer.innerHTML = products.map(product => `
        <div class="product-item" data-id="${product.id}">
          <div class="product-image">
            <img src="${product.imageUrl}" alt="${escapeHtml(product.name)}" loading="lazy">
          </div>
          <div class="product-details">
            <h3>${escapeHtml(product.name)}</h3>
            <p class="product-price">£${product.price.toFixed(2)}</p>
            <p class="product-category">${escapeHtml(product.category)}</p>
            <p class="product-description">${escapeHtml(product.description)}</p>
            <small class="product-meta">
              Added ${formatDate(product.createdAt)}
            </small>
          </div>
          <div class="product-actions">
            <button class="btn btn-danger btn-sm" onclick="deleteProduct('${product.id}', '${product.imagePath}')">
              Delete
            </button>
          </div>
        </div>
      `).join('');
    }

    // ========================================
    // DELETE PRODUCT
    // ========================================
    window.deleteProduct = async (productId, imagePath) => {
      if (!confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
        return;
      }

      try {
        // 1. Delete image from Storage
        if (imagePath) {
          const imageRef = ref(storage, imagePath);
          await deleteObject(imageRef);
        }

        // 2. Delete document from Firestore
        await deleteDoc(doc(db, 'products', productId));

        showMessage('Product deleted successfully', 'success');
      } catch (error) {
        console.error('Delete error:', error);
        showMessage('Failed to delete product. Please try again.', 'error');
      }
    };

    // ========================================
    // HELPER FUNCTIONS
    // ========================================
    function setSubmitLoading(isLoading) {
      submitBtn.disabled = isLoading;
      submitText.style.display = isLoading ? 'none' : 'inline';
      submitSpinner.style.display = isLoading ? 'inline-block' : 'none';
      
      // Disable form inputs
      const inputs = productForm.querySelectorAll('input, textarea, select, button');
      inputs.forEach(input => input.disabled = isLoading);
    }

    function showUploadProgress(percent, text = 'Uploading...') {
      uploadProgress.style.display = 'block';
      updateUploadProgress(percent, text);
    }

    function updateUploadProgress(percent, text) {
      progressFill.style.width = `${percent}%`;
      if (text) {
        progressText.textContent = `${text} (${Math.round(percent)}%)`;
      }
    }

    function hideUploadProgress() {
      setTimeout(() => {
        uploadProgress.style.display = 'none';
        progressFill.style.width = '0%';
      }, 1000);
    }

    function showMessage(message, type = 'info') {
      formMessage.textContent = message;
      formMessage.className = `form-message ${type}`;
      formMessage.style.display = 'block';
      formMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function hideMessage() {
      formMessage.style.display = 'none';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(timestamp) {
      if (!timestamp) return 'Unknown';
      
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
      if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
      if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
      
      return date.toLocaleDateString('en-GB', { 
        day: 'numeric', 
        month: 'short', 
        year: 'numeric' 
      });
    }
  </script>
</body>
</html>